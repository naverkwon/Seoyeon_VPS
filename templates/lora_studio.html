<!DOCTYPE html>
<html lang="en" data-theme="cupcake">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LoRA Studio</title>
    <!-- Tailwind + DaisyUI -->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@3.9.4/dist/full.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;500;700&display=swap');

        body {
            font-family: 'Outfit', 'Noto Sans KR', sans-serif;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.05);
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 1rem;
        }

        .gallery-item {
            aspect-ratio: 4/5;
            border-radius: 0.5rem;
            overflow: hidden;
            position: relative;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .gallery-item:hover {
            border-color: #f472b6;
            transform: scale(1.02);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
    </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-pink-50 via-white to-purple-50 text-gray-800">

    <!-- Navbar -->
    <div class="navbar bg-white/50 backdrop-blur fixed top-0 z-50 border-b border-white/40">
        <div class="flex-1">
            <a
                class="btn btn-ghost normal-case text-xl font-bold bg-gradient-to-r from-pink-400 to-purple-500 text-transparent bg-clip-text">üå∏
                LoRA Studio</a>
        </div>
        <div class="flex-none gap-2">
            <a href="http://localhost:5001/gallery" target="_blank"
                class="btn btn-ghost btn-sm text-gray-500 hover:text-pink-500">
                üñºÔ∏è Gallery
            </a>
            <label class="swap swap-rotate btn btn-ghost btn-circle btn-sm">
                <input type="checkbox" onchange="toggleLang(this)" />
                <span class="swap-on text-xs font-bold">EN</span>
                <span class="swap-off text-xs font-bold">KR</span>
            </label>
        </div>
    </div>

    <!-- Container -->
    <div class="container mx-auto pt-24 px-4 pb-12 flex flex-col lg:flex-row gap-8">

        <!-- LEFT: Controls (Scrollable) -->
        <div class="lg:w-1/3 flex flex-col gap-6 max-h-[calc(100vh-120px)] overflow-y-auto pr-2 scrollbar-thin">

            <!-- Character Selector -->
            <div class="card glass-panel p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xs uppercase tracking-widest text-gray-500 font-bold lang-subject">Subject</h2>
                    <button
                        class="btn btn-xs btn-circle btn-ghost text-pink-500 border border-pink-200 hover:bg-pink-50"
                        onclick="openEditor()">+</button>
                </div>
                <select id="char-select" class="select select-bordered w-full bg-white/50"
                    onchange="selectChar(this.value)">
                    <option disabled selected>Loading...</option>
                </select>
                <div class="mt-4 flex items-center gap-4">
                    <div class="avatar">
                        <div class="w-16 h-16 rounded-full ring ring-pink-300 ring-offset-base-100 ring-offset-2 shadow-sm cursor-pointer hover:ring-4 transition-all"
                            onclick="openEditor()" title="Click to Edit Profile">
                            <img id="char-img" src="/static/images/seoyeon.jpg" alt="avatar"
                                class="rounded-full object-cover w-full h-full"
                                onerror="this.src='https://placehold.co/100x100?text=User'" />
                        </div>
                    </div>
                    <div>
                        <h3 class="font-bold text-lg text-gray-800" id="char-name">Seoyeon</h3>
                        <p class="text-xs text-gray-500" id="char-desc">K-Pop Idol Visual</p>
                    </div>
                </div>
            </div>

            <!-- Settings -->
            <div class="card glass-panel p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xs uppercase tracking-widest text-gray-500 font-bold lang-config">Configuration</h2>
                    <!-- Mode Toggle -->
                    <!-- Mode Toggle Removed -->
                </div>

                <!-- AUTO MODE: Level Slider -->
                <div id="mode-auto">
                    <div class="form-control w-full mb-4">
                        <label class="label"><span class="label-text text-gray-600 font-medium lang-level">Safety
                                Level</span></label>
                        <input type="range" min="0" max="3" value="0" class="range range-xs range-primary" step="1"
                            id="level-slider" oninput="updateLevelLabel(this.value)" />
                        <div
                            class="w-full flex justify-between text-[10px] px-1 mt-2 text-gray-400 uppercase font-bold tracking-wider">
                            <span>SFW</span>
                            <span>Tease</span>
                            <span>NSFW(M)</span>
                            <span>NSFW(E)</span>
                        </div>
                    </div>
                </div>

                <!-- BUILDER MODE: Dropdowns (Always Visible) -->
                <div id="mode-builder" class="flex flex-col gap-3 mb-4">
                    <!-- Location -->
                    <div class="form-control w-full">
                        <label class="label py-1"><span
                                class="label-text text-xs font-bold text-gray-500 lang-build-loc">Location</span></label>
                        <select class="select select-bordered select-xs w-full bg-white/70" id="b-location">
                            <option value="">Random (Auto)</option>
                            {% for loc in locations %}
                            <option value="{{ loc }}">{{ loc }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <!-- Pose -->
                    <div class="form-control w-full">
                        <label class="label py-1"><span
                                class="label-text text-xs font-bold text-gray-500 lang-build-pose">Pose</span></label>
                        <select class="select select-bordered select-xs w-full bg-white/70" id="b-pose">
                            <option value="">Random (Auto)</option>
                            {% for pose in poses %}
                            <option value="{{ pose }}">{{ pose }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <!-- DYNAMIC: Advanced Solo (Public) -->
                    <div id="ui-public" class="p-3 bg-green-50 rounded-lg border border-green-100 mb-4 hidden">
                        <h3 class="text-xs font-bold text-green-500 mb-2 uppercase tracking-wide">üå≥ Public / Solo</h3>
                        <div class="form-control w-full mb-2">
                            <label class="label py-1"><span
                                    class="label-text text-xs text-gray-500">Location</span></label>
                            <select id="public-loc" class="select select-bordered select-xs w-full">
                                <option value="">None (Private)</option>
                                <option value="han_river_park">Han River Park</option>
                                <option value="subway">Subway</option>
                                <option value="cafe">Cafe Window</option>
                                <option value="street_night">Night Street</option>
                                <option value="library">Library</option>
                                <option value="gym">Gym</option>
                            </select>
                        </div>
                    </div>

                    <!-- CONSTANT: AI Director (Camera & Lens) -->
                    <div class="p-3 bg-gray-50 rounded-lg border border-gray-100 mb-4">
                        <h3 class="text-xs font-bold text-gray-500 mb-2 uppercase tracking-wide">üé¨ AI Director</h3>
                        <div class="flex gap-2">
                            <div class="form-control w-1/2">
                                <label class="label py-1"><span
                                        class="label-text text-xs text-gray-500">Angle</span></label>
                                <select id="dir-angle" class="select select-bordered select-xs w-full">
                                    <option value="">‚ú® Auto (Random)</option>
                                    <option value="view from below">Low Angle (Legs)</option>
                                    <option value="view from above">High Angle (Face)</option>
                                    <option value="dutch angle">Dutch Angle (Dynamic)</option>
                                    <option value="selfie angle">Selfie View</option>
                                    <option value="eye level shot">Eye Level</option>
                                    <option value="from behind">From Behind</option>
                                </select>
                            </div>
                            <div class="form-control w-1/2">
                                <label class="label py-1"><span
                                        class="label-text text-xs text-gray-500">Lens</span></label>
                                <select id="dir-lens" class="select select-bordered select-xs w-full">
                                    <option value="">‚ú® Auto (Random)</option>
                                    <option value="wide angle lens">Wide (Background)</option>
                                    <option value="85mm portrait lens">85mm (Portrait)</option>
                                    <option value="telephoto lens">Telephoto (Zoom)</option>
                                    <option value="fisheye lens">Fisheye (Fun)</option>
                                    <option value="macro lens">Macro (Close-up)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <!-- Outfit -->
                    <div class="form-control w-full">
                        <!-- Expanded Outfit Controls -->
                        <div class="form-control w-full">
                            <label class="label"><span class="label-text lang-build-top font-semibold">Top /
                                    Dress</span></label>
                            <select id="build-top" class="select select-bordered select-sm w-full bg-white/50">
                                <option value="" selected>Random</option>
                                {% for item in tops %}
                                <option value="{{ item }}">{{ item }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-control w-full">
                            <label class="label"><span
                                    class="label-text lang-build-bottom font-semibold">Bottom</span></label>
                            <select id="build-bottom" class="select select-bordered select-sm w-full bg-white/50">
                                <option value="" selected>Random / None</option>
                                {% for item in bottoms %}
                                <option value="{{ item }}">{{ item }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-control w-full">
                            <label class="label"><span
                                    class="label-text lang-build-outer font-semibold">Outerwear</span></label>
                            <select id="build-outer" class="select select-bordered select-sm w-full bg-white/50">
                                <option value="" selected>None / Random</option>
                                {% for item in outers %}
                                <option value="{{ item }}">{{ item }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <!-- Hair -->
                        <div class="form-control w-full">
                            <label class="label py-1"><span
                                    class="label-text text-xs font-bold text-gray-500 lang-build-hair">Hair</span></label>
                            <select class="select select-bordered select-xs w-full bg-white/70" id="b-hair">
                                <option value="">Random (Auto)</option>
                                {% for hair in hair_styles %}
                                <option value="{{ hair }}">{{ hair }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <!-- Category (Common) -->
                    <div class="form-control w-full mb-4">
                        <label class="label"><span
                                class="label-text text-gray-600 font-medium lang-category">Category</span></label>
                        <select
                            class="select select-bordered select-sm w-full bg-white/70 focus:outline-none focus:border-pink-300"
                            id="category-select">
                            <option value="general" class="lang-opt-gen">General</option>
                            <option value="with_male" class="lang-opt-male">Interaction</option>
                            <option value="fantasy" class="lang-opt-fan">Fantasy</option>
                            <option value="transport" class="lang-opt-trans">Transport</option>
                        </select>
                    </div>

                    <!-- Count -->
                    <div class="form-control w-full mb-6">
                        <label class="label"><span class="label-text text-gray-600 font-medium lang-count">Batch
                                Size</span></label>
                        <div class="join w-full shadow-sm" id="count-group">
                            <button
                                class="join-item btn btn-sm flex-1 bg-pink-100 border-pink-200 text-pink-600 font-bold"
                                onclick="setCount(1, this)">x1</button>
                            <button
                                class="join-item btn btn-sm flex-1 bg-white border-gray-200 text-gray-500 font-normal"
                                onclick="setCount(5, this)">x5</button>
                            <button
                                class="join-item btn btn-sm flex-1 bg-white border-gray-200 text-gray-500 font-normal"
                                onclick="setCount(10, this)">x10</button>
                        </div>
                        <input type="hidden" id="count-val" value="1">
                    </div>


                    <!-- End of Builder Mode specific fields -->
                </div>

                <!-- Generate Button (Always Visible now outside hidden div) -->
                <button
                    class="btn btn-primary w-full bg-gradient-to-r from-pink-400 to-purple-400 border-none hover:shadow-lg hover:shadow-pink-200 text-white shadow-md transform transition active:scale-95 text-lg"
                    onclick="generatePrompt()">
                    <span class="mr-2">‚ú®</span> <span class="lang-btn">ÎßàÎ≤ïÏùò ÌîÑÎ°¨ÌîÑÌä∏ ÏÉùÏÑ±</span>
                </button>
            </div>
        </div>

        <!-- RIGHT: Results -->
        <div class="lg:w-2/3 flex flex-col gap-6 h-full">
            <div class="card glass-panel p-6 h-full min-h-[700px] relative flex flex-col">
                <div class="flex justify-between items-center mb-4 border-b border-gray-100 pb-2">
                    <div class="flex bg-gray-100 p-1 rounded-lg gap-1">
                        <button
                            class="btn btn-xs btn-ghost bg-white shadow-sm text-pink-500 font-bold hover:bg-white rounded-md px-3"
                            onclick="switchRightTab('results', this)">Results</button>
                        <button class="btn btn-xs btn-ghost text-gray-400 font-bold hover:text-gray-600 rounded-md px-3"
                            onclick="switchRightTab('gallery', this)">Gallery</button>
                    </div>
                    <button class="btn btn-ghost btn-xs text-gray-400 hover:text-pink-500 lang-clear"
                        onclick="clearResults()">Clear All</button>
                </div>

                <!-- Tab: RESULTS -->
                <div id="tab-results" class="flex flex-col h-full">

                    <!-- Negative Prompt (Sticky within Card) -->
                    <div
                        class="bg-gray-50 rounded-lg p-3 mb-4 flex justify-between items-center border border-gray-100 shadow-inner">
                        <div class="flex flex-col overflow-hidden w-full mr-2">
                            <span class="text-[10px] font-bold text-gray-400 uppercase mb-1 lang-neg">Negative
                                Prompt</span>
                            <p class="text-xs text-gray-600 font-mono truncate select-all">low quality, blurry,
                                deformed,
                                watermark, text, (worst quality:1.4), (bad quality:1.4)</p>
                        </div>
                        <button class="btn btn-circle btn-xs btn-ghost text-gray-400 hover:bg-white hover:text-pink-500"
                            onclick="copyText(this, 'low quality, blurry, deformed, watermark, text, (worst quality:1.4), (bad quality:1.4)')">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                            </svg>
                        </button>
                    </div>

                    <!-- Placeholder (Moved Out) -->
                    <div id="placeholder" class="text-center text-gray-400 py-20">
                        <div class="text-4xl mb-4 opacity-50">üîÆ</div>
                        <p class="font-light lang-placeholder">ÏÑ§Ï†ïÏùÑ Ï°∞Ï†àÌïòÍ≥† ÏÉùÏÑ± Î≤ÑÌäºÏùÑ ÎàÑÎ•¥ÏÑ∏Ïöî</p>
                    </div>

                    <div id="results-container"
                        class="flex flex-col gap-4 overflow-y-auto max-h-[calc(100vh-180px)] pr-2 scrollbar-hide mb-4">
                        <!-- Pagination Controls (Added via Phase 9) -->
                        <div id="pagination-controls" class="flex justify-between items-center mt-2 hidden">
                            <button class="btn btn-sm btn-ghost" onclick="changePage(-1)">¬´ Prev</button>
                            <span class="text-xs text-gray-500 font-mono" id="page-indicator">Page 1</span>
                            <button class="btn btn-sm btn-ghost" onclick="changePage(1)">Next ¬ª</button>
                        </div>
                    </div>
                </div> <!-- End Tab Results -->

                <!-- Tab: GALLERY -->
                <div id="tab-gallery"
                    class="hidden flex flex-col h-full overflow-y-auto pr-2 scrollbar-hide max-h-[600px]">
                    <div id="gallery-container" class="gallery-grid">
                        <!-- JS populated -->
                        <div class="col-span-full text-center py-20 text-gray-400">
                            <span class="loading loading-dots loading-lg"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Javascript -->
    <!-- Editor Modal -->
    <dialog id="editor_modal" class="modal">
        <form method="dialog"
            class="modal-box w-11/12 max-w-2xl bg-white/95 backdrop-blur border border-white shadow-xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-lg text-pink-500 lang-modal-title">‚ú® Create New Profile</h3>
                <button type="button" class="btn btn-sm btn-ghost text-pink-400 gap-2" onclick="randomizeCharacter()">
                    üé≤ <span class="lang-random">Random</span>
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Basic Info -->
                <div class="form-control">
                    <label class="label"><span class="label-text lang-modal-name">Name</span></label>
                    <input type="text" id="new-name" class="input input-bordered input-sm"
                        placeholder="Ïòà: ÏßÄÏàò (Jisoo)" />
                </div>
                <div class="form-control">
                    <label class="label"><span class="label-text lang-modal-trigger">Trigger Word</span></label>
                    <input type="text" id="new-trigger" class="input input-bordered input-sm" placeholder="Ïòà: jisoo" />
                </div>

                <!-- Appearance -->
                <div class="form-control">
                    <label class="label"><span class="label-text lang-modal-ethnicity">Ethnicity</span></label>
                    <input type="text" id="new-ethnicity" class="input input-bordered input-sm" value="Korean" />
                </div>
                <div class="form-control">
                    <label class="label"><span class="label-text lang-modal-gender">Gender</span></label>
                    <select id="new-gender" class="select select-bordered select-sm">
                        <option value="female" class="lang-gender-f" selected>Female</option>
                        <option value="male" class="lang-gender-m">Male</option>
                    </select>
                </div>
                <div class="form-control">
                    <label class="label"><span class="label-text lang-modal-face">Face Type</span></label>
                    <input type="text" id="new-face" class="input input-bordered input-sm" placeholder="Ïòà: Í∑ÄÏó¨Ïö¥ ÏïÑÏù¥ÎèåÏÉÅ" />
                </div>
                <div class="form-control">
                    <label class="label"><span class="label-text lang-modal-features">Facial Features</span></label>
                    <input type="text" id="new-features" class="input input-bordered input-sm"
                        placeholder="Ïòà: Í≥†ÏñëÏù¥ÏÉÅ, Ï†ê" />
                </div>
                <div class="form-control">
                    <label class="label"><span class="label-text lang-modal-age">Age Range</span></label>
                    <input type="text" id="new-age" class="input input-bordered input-sm" value="early 20s" />
                </div>

                <!-- Hair & Body -->
                <div class="form-control">
                    <label class="label"><span class="label-text lang-modal-hair-color">Hair Color</span></label>
                    <input type="text" id="new-hair-color" class="input input-bordered input-sm" value="black" />
                </div>
                <div class="form-control">
                    <label class="label"><span class="label-text lang-modal-hair-len">Hair Length</span></label>
                    <input type="text" id="new-hair-length" class="input input-bordered input-sm" value="long" />
                </div>
                <div class="form-control">
                    <label class="label"><span class="label-text lang-modal-body">Body Type</span></label>
                    <input type="text" id="new-body" class="input input-bordered input-sm" value="slim body" />
                </div>

                <!-- Avatar Upload -->
                <div class="form-control">
                    <label class="label"><span class="label-text lang-modal-img">Profile Image</span></label>
                    <input type="file" id="new-avatar" class="file-input file-input-bordered file-input-sm w-full"
                        accept="image/*" />
                </div>
            </div>

            <!-- Portrait Prompt Result Area -->
            <div id="portrait-result" class="hidden mt-4 p-3 bg-base-200 rounded-lg border border-base-300">
                <div class="flex justify-between items-center mb-1">
                    <span class="text-xs font-bold text-gray-500 lang-portrait-label">üì∏ Portrait Prompt</span>
                    <button class="btn btn-xs btn-ghost text-pink-500 lang-copy" type="button"
                        onclick="copyPortraitPrompt()">üìã
                        Copy</button>
                </div>
                <textarea id="portrait-prompt-text" class="textarea textarea-bordered w-full h-20 text-xs leading-tight"
                    readonly></textarea>
            </div>

            <div class="modal-action">
                <button class="btn btn-error btn-outline mr-auto lang-modal-delete" type="button"
                    onclick="deleteCharacter()">üóëÔ∏è Delete
                    Profile</button>
                <button class="btn btn-info btn-outline" type="button" onclick="createPortraitPrompt()">üì∏ Gen
                    Portrait</button>
                <button class="btn btn-ghost lang-modal-cancel"
                    onclick="document.getElementById('editor_modal').close()">Cancel</button>
                <button class="btn btn-primary bg-pink-500 border-none text-white lang-modal-save" type="button"
                    onclick="saveCharacter()">Save Profile</button>
            </div>
        </form>
    </dialog>

    <!-- Lightbox Modal -->
    <dialog id="lightbox_modal" class="modal bg-black/90 backdrop-blur-md">
        <form method="dialog"
            class="modal-box max-w-5xl bg-transparent shadow-none p-0 overflow-visible relative text-center">

            <button class="btn btn-circle btn-ghost absolute right-0 top-0 text-white z-50 transform hover:scale-110"
                onclick="document.getElementById('lightbox_modal').close()">‚úï</button>
            <button
                class="btn btn-circle btn-ghost absolute left-5 top-1/2 text-white z-50 text-4xl transform -translate-y-1/2 hover:bg-white/20"
                onclick="navGallery(-1)">‚ùÆ</button>
            <button
                class="btn btn-circle btn-ghost absolute right-5 top-1/2 text-white z-50 text-4xl transform -translate-y-1/2 hover:bg-white/20"
                onclick="navGallery(1)">‚ùØ</button>

            <img id="lightbox-img" src="" class="max-h-[85vh] rounded-lg shadow-2xl mx-auto border-4 border-white/10"
                alt="Full size" />

            <div class="mt-4 text-white/70 font-mono text-sm" id="lightbox-counter"></div>
        </form>
    </dialog>

    <script>
        let selectedChar = 'seoyeon';
        let currentLang = 'KR';
        let currentMode = 'auto'; // 'auto' or 'builder'
        let CHAR_DATA = {};

        let currentGalleryIndex = 0;
        let GALLERY_IMAGES = []; // Store current gallery data for navigation

        // Listen for Keyboard Navigation
        document.addEventListener('keydown', (e) => {
            const modal = document.getElementById('lightbox_modal');
            if (modal.open) {
                if (e.key === 'ArrowLeft') navGallery(-1);
                if (e.key === 'ArrowRight') navGallery(1);
            }
        });

        // INIT ON LOAD
        document.addEventListener('DOMContentLoaded', () => {
            console.log("üöÄ DOMContentLoaded fired!");
            loadCharacters();
            loadHistory(); // Load saved prompts
        });

        // Track editing state
        let editingCharId = null;

        const LEVELS = ['sfw', 'tease', 'nsfw_moderate', 'nsfw_extreme'];

        // Random Datasets
        const R_NAMES = ["Jisoo", "Jennie", "Lisa", "Ros√©", "Karina", "Winter", "Giselle", "Ningning", "Yujin", "Gaeul", "Rei", "Wonyoung", "Liz", "Leeseo", "Minji", "Hanni", "Danielle", "Haerin", "Hyein", "Sakura", "Chaewon", "Yunjin", "Kazuha", "Eunchae", "Soyeon", "Miyeon", "Minnie", "Yuqi", "Shuhua", "Yeji", "Lia", "Ryujin", "Chaeryeong", "Yuna"];
        const R_FACES = ["Puppy-like cute face", "Cat-like sharp face", "Fox-like seductive face", "Deer-like innocent face", "Bunny-like bright face", "Wolf-like cool face", "Classic beauty face", "Trendy influencer face"];
        const R_FEATURES = ["Dimples", "Mole under eye", "Sharp jawline", "High nose bridge", "Monolid eyes", "Double eyelids", "Big round eyes", "Cat eyes", "Thick eyebrows", "Plump lips"];
        const R_HAIRS = ["Jet black", "Dark brown", "Ash gray", "Platinum blonde", "Pinkish brown", "Blue black", "Milk tea brown"];
        const R_BODIES = ["Slim", "Athletic", "Curvy", "Model-tall", "Petite", "Glamorous"];

        // Language Data
        const DICT = {
            'KR': {
                'subject': 'ÎåÄÏÉÅ', 'config': 'ÏÑ§Ï†ï', 'level': 'ÏàòÏúÑ', 'category': 'Ïπ¥ÌÖåÍ≥†Î¶¨', 'count': 'ÏÉùÏÑ± Í∞úÏàò',
                'opt-gen': 'ÏùºÎ∞ò', 'opt-male': 'ÎÇ®ÏÑ± ÏÉÅÌò∏ÏûëÏö©', 'opt-fan': 'ÌåêÌÉÄÏßÄ/ÏΩîÏä§ÌîÑÎ†à', 'opt-trans': 'Ïù¥ÎèôÏàòÎã®',
                'btn': 'ÎßàÎ≤ïÏùò ÌîÑÎ°¨ÌîÑÌä∏ ÏÉùÏÑ±', 'results': 'ÏÉùÏÑ± Í≤∞Í≥º', 'clear': 'Ï†ÑÏ≤¥ ÏÇ≠Ï†ú', 'placeholder': 'ÏÑ§Ï†ïÏùÑ Ï°∞Ï†àÌïòÍ≥† ÏÉùÏÑ± Î≤ÑÌäºÏùÑ ÎàÑÎ•¥ÏÑ∏Ïöî',
                'neg': 'ÎÑ§Í±∞Ìã∞Î∏å ÌîÑÎ°¨ÌîÑÌä∏ (Í≥µÌÜµ)',
                'random': 'ÎûúÎç§ ÏÉùÏÑ±',
                // Builder Mode
                'build-loc': 'Ïû•ÏÜå', 'build-pose': 'Ìè¨Ï¶à', 'build-hair': 'Ìó§Ïñ¥Ïä§ÌÉÄÏùº',
                'build-top': 'ÏÉÅÏùò / ÏõêÌîºÏä§', 'build-bottom': 'ÌïòÏùò', 'build-outer': 'ÏïÑÏö∞ÌÑ∞',
                'build-mode': 'ÏÉÅÏÑ∏ ÎπåÎçî Î™®Îìú', 'auto-mode': 'ÏûêÎèô ÏÉùÏÑ± Î™®Îìú',
                // Editor Modal
                'modal-title': '‚ú® ÏÉà Ï∫êÎ¶≠ÌÑ∞ ÌîÑÎ°úÌïÑ ÎßåÎì§Í∏∞',
                'modal-name': 'Ïù¥Î¶Ñ', 'modal-trigger': 'Ìä∏Î¶¨Í±∞ Îã®Ïñ¥ (LoRA)',
                'modal-ethnicity': 'Ïù∏Ï¢Ö', 'modal-gender': 'ÏÑ±Î≥Ñ', 'modal-face': 'ÏñºÍµ¥ ÌäπÏßï (ÏÉÅ)', 'modal-features': 'ÏÑ∏Î∂Ä ÌäπÏßï',
                'modal-age': 'ÎÇòÏù¥ÎåÄ', 'modal-hair-color': 'Î®∏Î¶¨ÏÉâ', 'modal-hair-len': 'Î®∏Î¶¨ Í∏∏Ïù¥',
                'modal-body': 'Ï≤¥Ìòï', 'modal-img': 'ÌîÑÎ°úÌïÑ Ïù¥ÎØ∏ÏßÄ',
                'modal-cancel': 'Ï∑®ÏÜå', 'modal-save': 'ÌîÑÎ°úÌïÑ Ï†ÄÏû•',
                'modal-delete': 'üóëÔ∏è ÌîÑÎ°úÌïÑ ÏÇ≠Ï†ú', 'portrait-label': 'üì∏ Ï¥àÏÉÅÌôî ÌîÑÎ°¨ÌîÑÌä∏', 'copy': 'üìã Î≥µÏÇ¨',
                'gender-f': 'Ïó¨ÏÑ±', 'gender-m': 'ÎÇ®ÏÑ±'
            },
            'EN': {
                'subject': 'Subject', 'config': 'Configuration', 'level': 'Safety Level', 'category': 'Category', 'count': 'Batch Size',
                'opt-gen': 'General', 'opt-male': 'Interaction', 'opt-fan': 'Fantasy', 'opt-trans': 'Transport',
                'btn': 'Generate Magic Prompt', 'results': 'Generated Results', 'clear': 'Clear All', 'placeholder': 'Adjust settings and click Generate',
                'neg': 'Negative Prompt (Common)',
                'random': 'Randomize',
                // Builder Mode
                'build-loc': 'Location', 'build-pose': 'Pose', 'build-hair': 'Hair Style',
                'build-top': 'Top / Dress', 'build-bottom': 'Bottom', 'build-outer': 'Outerwear',
                'build-mode': 'Builder Mode', 'auto-mode': 'Auto Mode',
                // Editor Modal
                'modal-title': '‚ú® Create New Profile',
                'modal-name': 'Name', 'modal-trigger': 'Trigger Word',
                'modal-ethnicity': 'Ethnicity', 'modal-gender': 'Gender', 'modal-face': 'Face Type',
                'modal-features': 'Facial Features', 'modal-age': 'Age Range',
                'modal-hair-color': 'Hair Color', 'modal-hair-len': 'Hair Length',
                'modal-body': 'Body Type', 'modal-img': 'Profile Image',
                'modal-cancel': 'Cancel', 'modal-save': 'Save Profile',
                'modal-delete': 'üóëÔ∏è Delete Profile', 'portrait-label': 'üì∏ Portrait Prompt', 'copy': 'üìã Copy',
                'gender-f': 'Female', 'gender-m': 'Male'
            }
        };

        function toggleLang(checkbox) {
            currentLang = checkbox.checked ? 'EN' : 'KR';
            updateLangUI();
        }

        function updateLangUI() {
            const t = DICT[currentLang];

            // Common
            document.querySelector('.lang-subject').innerText = t['subject'];
            document.querySelector('.lang-config').innerText = t['config'];
            document.querySelector('.lang-level').innerText = t['level'];
            document.querySelector('.lang-category').innerText = t['category'];
            document.querySelector('.lang-count').innerText = t['count'];

            // Options
            document.querySelector('.lang-opt-gen').innerText = t['opt-gen'];
            document.querySelector('.lang-opt-male').innerText = t['opt-male'];
            document.querySelector('.lang-opt-fan').innerText = t['opt-fan'];
            document.querySelector('.lang-opt-trans').innerText = t['opt-trans'];

            // Main Controls
            document.querySelector('.lang-btn').innerText = t['btn'];
            document.querySelector('.lang-results').innerText = t['results'];
            document.querySelector('.lang-clear').innerText = t['clear'];
            document.querySelector('.lang-placeholder').innerText = t['placeholder'];
            document.querySelector('.lang-neg').innerText = t['neg'];

            // Builder Mode
            const buildLoc = document.querySelector('.lang-build-loc');
            if (buildLoc) buildLoc.innerText = t['build-loc'];
            const buildPose = document.querySelector('.lang-build-pose');
            if (buildPose) buildPose.innerText = t['build-pose'];
            if (buildPose) buildPose.innerText = t['build-pose'];
            const buildTop = document.querySelector('.lang-build-top');
            if (buildTop) buildTop.innerText = t['build-top'];
            const buildBottom = document.querySelector('.lang-build-bottom');
            if (buildBottom) buildBottom.innerText = t['build-bottom'];
            const buildOuter = document.querySelector('.lang-build-outer');
            if (buildOuter) buildOuter.innerText = t['build-outer'];

            const buildHair = document.querySelector('.lang-build-hair');
            if (buildHair) buildHair.innerText = t['build-hair'];

            // Builder Labels
            // Note: Currently Builder mode labels in HTML might not have these classes yet.
            // I need to ensure the HTML for Builder Mode has these classes (lang-build-loc, etc).
            // Let's assume I will update the HTML below or in a separate call if needed.
            // Actually, I am replacing the script block, but I didn't replace the Builder Mode HTML block in this call?
            // The Builder Mode HTML is likely around line 130. I am editing from line 243.
            // Wait, I am replacing 'Editor Modal' AND 'Script'. I must make sure I don't miss the Builder Mode HTML edits.
            // Since this tool call targets line 242+, I cannot edit line 130 here.
            // I will implement the Editor Modal translations first, then do a second pass for Builder Mode HTML.

            // Editor Modal
            if (document.querySelector('.lang-modal-title')) {
                document.querySelector('.lang-modal-title').innerText = t['modal-title'];
                document.querySelector('.lang-modal-name').innerText = t['modal-name'];
                document.querySelector('.lang-modal-trigger').innerText = t['modal-trigger'];
                document.querySelector('.lang-modal-ethnicity').innerText = t['modal-ethnicity'];
                document.querySelector('.lang-modal-face').innerText = t['modal-face'];
                document.querySelector('.lang-modal-features').innerText = t['modal-features'];
                document.querySelector('.lang-modal-age').innerText = t['modal-age'];
                document.querySelector('.lang-modal-hair-color').innerText = t['modal-hair-color'];
                document.querySelector('.lang-modal-hair-len').innerText = t['modal-hair-len'];
                document.querySelector('.lang-modal-body').innerText = t['modal-body'];
                document.querySelector('.lang-modal-img').innerText = t['modal-img'];
                document.querySelector('.lang-modal-cancel').innerText = t['modal-cancel'];
                document.querySelector('.lang-modal-save').innerText = t['modal-save'];
                if (document.querySelector('.lang-random')) document.querySelector('.lang-random').innerText = t['random'];

                // New Translations
                if (document.querySelector('.lang-modal-gender')) document.querySelector('.lang-modal-gender').innerText = t['modal-gender'];
                if (document.querySelector('.lang-gender-f')) document.querySelector('.lang-gender-f').innerText = t['gender-f'];
                if (document.querySelector('.lang-gender-m')) document.querySelector('.lang-gender-m').innerText = t['gender-m'];
                if (document.querySelector('.lang-modal-delete')) document.querySelector('.lang-modal-delete').innerText = t['modal-delete'];
                if (document.querySelector('.lang-portrait-label')) document.querySelector('.lang-portrait-label').innerText = t['portrait-label'];
                if (document.querySelector('.lang-copy')) document.querySelector('.lang-copy').innerText = t['copy'];
            }
        }

        function setMode(mode, tab) {
            currentMode = mode;
            // Tab UI
            tab.parentElement.querySelectorAll('a').forEach(t => t.classList.remove('tab-active'));
            tab.classList.add('tab-active');

            // Visibility
            if (mode === 'auto') {
                document.getElementById('mode-auto').classList.remove('hidden');
                document.getElementById('mode-builder').classList.add('hidden');
            } else {
                document.getElementById('mode-auto').classList.add('hidden');
                document.getElementById('mode-builder').classList.remove('hidden');
            }
        }
        async function saveCharacter() {
            // Collect Data
            const name = document.getElementById('new-name').value;
            const trigger = document.getElementById('new-trigger').value;
            if (!name) { alert(DICT[currentLang]['modal-name'] + " is required"); return; }

            const profile = {
                id: editingCharId ? editingCharId : name.toLowerCase().replace(/\s+/g, '_') + (editingCharId ? "" : "_v1"),
                name: name,
                lora_trigger: trigger,
                fixed_base: {
                    ethnicity: document.getElementById('new-ethnicity').value,
                    gender: document.getElementById('new-gender').value, // Added Gender
                    face_type: document.getElementById('new-face').value,
                    facial_features: document.getElementById('new-features').value,
                    age_range: document.getElementById('new-age').value,
                    skin_tone: 'fair skin', // default
                    makeup_style: 'natural minimal makeup', // default
                    hair_color: document.getElementById('new-hair-color').value,
                    hair_length: document.getElementById('new-hair-length').value,
                    bangs: 'no bangs', // default
                    forehead: 'forehead', // default
                    body_type: document.getElementById('new-body').value
                },
                variable_attributes: {},
                constraints: { "negative_prompt": "low quality" },
                quality_preset: "Cinematic"
            };

            // FormData for Image Upload
            const formData = new FormData();
            formData.append('profile_data', JSON.stringify(profile));

            const fileInput = document.getElementById('new-avatar');
            if (fileInput.files.length > 0) {
                formData.append('avatar', fileInput.files[0]);
            }

            try {
                const res = await fetch('/api/save-character', {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();

                if (data.success) {
                    alert("Character Saved!");
                    location.reload();
                } else {
                    alert("Error saving: " + data.error);
                }
            } catch (e) {
                console.error(e);
                alert("System Error: " + e);
            }
        }

        function randomizeCharacter() {
            const rand = arr => arr[Math.floor(Math.random() * arr.length)];

            document.getElementById('new-name').value = rand(R_NAMES);
            const nameVal = document.getElementById('new-name').value;
            document.getElementById('new-trigger').value = nameVal.toLowerCase();

            document.getElementById('new-ethnicity').value = "Korean"; // Default
            document.getElementById('new-face').value = rand(R_FACES);
            document.getElementById('new-features').value = rand(R_FEATURES) + ", " + rand(R_FEATURES);
            document.getElementById('new-age').value = "early 20s";

            document.getElementById('new-hair-color').value = rand(R_HAIRS);
            document.getElementById('new-hair-length').value = "long";
            document.getElementById('new-body').value = rand(R_BODIES) + " body";
        }

        async function loadCharacters() {
            try {
                const res = await fetch('/api/characters');
                const data = await res.json();

                if (data.success) {
                    const select = document.getElementById('char-select');
                    select.innerHTML = ''; // Clear loading
                    CHAR_DATA = {};

                    data.characters.forEach((char, index) => {
                        CHAR_DATA[char.id] = char;

                        const option = document.createElement('option');
                        option.value = char.id;
                        option.innerText = char.name;
                        select.appendChild(option);

                        if (index === 0) {
                            select.value = char.id;
                            selectChar(char.id); // Select first
                        }
                    });
                }
            } catch (e) {
                console.error("Failed to load characters", e);
            }
        }

        function openEditor() {
            editingCharId = null; // Reset edit state
            document.getElementById('editor_modal').showModal();
            // Clear fields properly or Reset form
            document.getElementById('new-name').value = "";
            document.getElementById('new-trigger').value = "";
            // Reset title and button
            document.querySelector('.lang-modal-title').innerText = "‚ú® Create New Profile";
            document.querySelector('.lang-modal-save').innerText = "Save Character";
        }

        function closeEditor() {
            editingCharId = null;
        }




        // function selectChar(id, tabElement) { ... } -> Updated for Select
        function selectChar(id) {
            selectedChar = id;

            // UI Update from CHAR_DATA
            const char = CHAR_DATA[id];
            if (char) {
                document.getElementById('char-name').innerText = char.name + (char.id === selectedChar ? "" : "");
                // Add Edit Button dynamically
                const titleArea = document.getElementById('char-name');
                titleArea.innerHTML = `${char.name} <button class="btn btn-xs btn-outline btn-secondary ml-2" onclick="editCharacter('${char.id}')">Edit</button>`;

                document.getElementById('char-desc').innerText = char.description;
                document.getElementById('char-img').src = char.base_image;

                // Clear previous generator/portrait prompts to avoid confusion
                const portraitResult = document.getElementById('portrait-result');
                if (portraitResult) portraitResult.classList.add('hidden');
                const portraitText = document.getElementById('portrait-prompt-text');
                if (portraitText) portraitText.value = '';

                // Also clear main prompt output if desired? User said "front prompt remains".
                // Assuming they meant duplicate/stale text. Let's not clear main prompt history list, but maybe input box?
                // Actually, let's just clear the "Portrait Helper" result area as requested.
            }
        }

        async function deleteCharacter() {
            if (!confirm("Are you sure you want to delete this character? This action cannot be undone.")) return;

            const id = document.getElementById('new-name').value.toLowerCase().replace(/\s+/g, '_');
            // Wait, the modal inputs might be changed. Use 'editingCharId' global if available, or infer from context.
            // Actually, improved logic: use the global 'editingCharId' set when opening editor.

            if (!editingCharId) {
                alert("Cannot delete unsaved character.");
                return;
            }

            try {
                const res = await fetch('/api/delete-character', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ char_id: editingCharId })
                });
                const data = await res.json();

                if (data.success) {
                    alert('Character deleted.');
                    location.reload();
                } else {
                    alert('Delete failed: ' + data.error);
                }
            } catch (e) {
                alert('Error: ' + e);
            }
        }

        function createPortraitPrompt() {
            // Collect data from form
            const name = document.getElementById('new-name').value.trim();
            if (!name) {
                alert("‚ö†Ô∏è Please enter a Name first!");
                return;
            }

            const ethnicity = document.getElementById('new-ethnicity').value;
            const gender = document.getElementById('new-gender').value; // Added Gender
            const face = document.getElementById('new-face').value;
            const features = document.getElementById('new-features').value;
            const hairColor = document.getElementById('new-hair-color').value;
            const hairLength = document.getElementById('new-hair-length').value;

            // Construct parts list to avoid empty commas
            let parts = [
                "(masterpiece), best quality",
                `professional portrait of ${name}`
            ];

            if (ethnicity) parts.push(ethnicity);
            if (gender === 'female') parts.push("woman", "girl"); // Add gender keywords
            else if (gender === 'male') parts.push("man", "boy");

            if (face) parts.push(face);
            if (features) parts.push(features);
            if (hairColor) parts.push(hairColor + " hair"); // Add 'hair' context if missing?
            if (hairLength) parts.push(hairLength);
            parts.push("looking at viewer", "upper body", "simple background", "soft lighting", "8k", "highly detailed");

            const prompt = parts.join(", ");

            // Show in UI instead of alerting
            const resultArea = document.getElementById('portrait-result');
            const resultText = document.getElementById('portrait-prompt-text');

            resultArea.classList.remove('hidden');
            resultText.value = prompt;

            // Auto copy for convenience
            navigator.clipboard.writeText(prompt);
        }

        function copyPortraitPrompt() {
            const text = document.getElementById('portrait-prompt-text');
            text.select();
            navigator.clipboard.writeText(text.value).then(() => {
                // Visual feedback
                const btn = event.currentTarget;
                const original = btn.innerText;
                btn.innerText = "‚úÖ Copied!";
                setTimeout(() => btn.innerText = original, 1500);
            });
        }

        function editCharacter(id) {
            const char = CHAR_DATA[id];
            if (!char || !char.profile_data) return;

            editingCharId = id; // SET EDIT STATE

            const p = char.profile_data;
            const base = p.fixed_base || {};

            // Open Modal
            document.getElementById('editor_modal').showModal();

            // Populate Fields
            document.getElementById('new-name').value = char.name;
            document.getElementById('new-trigger').value = p.lora_trigger || "";

            document.getElementById('new-ethnicity').value = base.ethnicity || "Korean";
            document.getElementById('new-gender').value = base.gender || "female"; // Populate Gender
            document.getElementById('new-face').value = base.face_type || "";
            document.getElementById('new-features').value = base.facial_features || "";
            document.getElementById('new-age').value = base.age_range || "early 20s";

            document.getElementById('new-hair-color').value = base.hair_color || "";
            document.getElementById('new-hair-length').value = base.hair_length || "";
            document.getElementById('new-body').value = base.body_type || "";

            // Update UI Titles
            const title = document.querySelector('.lang-modal-title');
            if (title) title.innerText = "‚ú® Edit Profile: " + char.name;

            const saveBtn = document.querySelector('.lang-modal-save');
            if (saveBtn) saveBtn.innerText = "Update Profile";
        }

        function updateLevelLabel(val) {
            // Can add visual feedback if needed
        }

        function setCount(val, btn) {
            document.getElementById('count-val').value = val;

            // Visual Update
            const group = document.getElementById('count-group');
            group.querySelectorAll('.btn').forEach(b => {
                b.className = "join-item btn btn-sm flex-1 bg-white border-gray-200 text-gray-500 font-normal";
            });
            btn.className = "join-item btn btn-sm flex-1 bg-pink-100 border-pink-200 text-pink-600 font-bold";
        }

        function clearResults() {
            document.getElementById('results-container').innerHTML = '';
            const ph = document.getElementById('placeholder');
            if (ph) ph.style.display = 'block';
            localStorage.removeItem('promptHistory'); // Clear History
        }

        // HISTORY LOGIC
        // HISTORY LOGIC
        // Pagination State
        let historyPage = 0;
        const ITEMS_PER_PAGE = 10;
        let cachedHistory = [];

        function saveHistory(promptData) {
            cachedHistory = JSON.parse(localStorage.getItem('promptHistory') || '[]');
            cachedHistory.unshift(promptData); // Add to top
            if (cachedHistory.length > 50) cachedHistory.pop(); // Limit 50
            localStorage.setItem('promptHistory', JSON.stringify(cachedHistory));

            // Reset to page 0 to see new item
            historyPage = 0;
            renderHistoryPage();
            const ph = document.getElementById('placeholder');
            if (ph) ph.style.display = 'none';
        }

        function loadHistory() {
            // Load full history
            cachedHistory = JSON.parse(localStorage.getItem('promptHistory') || '[]');

            if (cachedHistory.length > 0) {
                const ph = document.getElementById('placeholder');
                if (ph) ph.style.display = 'none';

                // Reset to page 0 on load
                historyPage = 0;
                renderHistoryPage();
            } else {
                const controls = document.getElementById('pagination-controls');
                if (controls) controls.classList.add('hidden');
            }
        }

        function renderHistoryPage() {
            const container = document.getElementById('results-container');

            // Clear current list content (but custom safety check needed if controls are inside)
            // Since we append controls dynamically, clearing innerHTML is fine.
            container.innerHTML = '';

            // Slice data
            const start = historyPage * ITEMS_PER_PAGE;
            const end = start + ITEMS_PER_PAGE;
            const pageData = cachedHistory.slice(start, end);

            pageData.forEach(p => renderPromptCard(p, container, false)); // false = append

            // Create Pagination Controls
            const navDiv = document.createElement('div');
            navDiv.id = 'pagination-controls';
            navDiv.className = "flex justify-between items-center mt-4 p-2 bg-white/50 rounded-lg shrink-0"; // shrink-0 important
            navDiv.innerHTML = `
                <button class="btn btn-xs btn-outline ${historyPage === 0 ? 'btn-disabled' : ''}" onclick="changePage(-1)">¬´ Prev</button>
                <span class="text-xs font-bold text-gray-500">Page ${historyPage + 1} / ${Math.max(1, Math.ceil(cachedHistory.length / ITEMS_PER_PAGE))}</span>
                <button class="btn btn-xs btn-outline ${end >= cachedHistory.length ? 'btn-disabled' : ''}" onclick="changePage(1)">Next ¬ª</button>
            `;
            container.appendChild(navDiv);
        }

        function changePage(delta) {
            historyPage += delta;
            if (historyPage < 0) historyPage = 0;
            const maxPages = Math.ceil(cachedHistory.length / ITEMS_PER_PAGE);
            if (historyPage >= maxPages) historyPage = Math.max(0, maxPages - 1);

            renderHistoryPage();
            document.getElementById('results-container').scrollTop = 0;
        }
        function renderPromptCard(p, container, insertAtTop = true) {
            const card = document.createElement('div');
            card.className = "card bg-white/80 border border-white shadow-sm p-4 hover:shadow-md hover:border-pink-200 transition-all duration-300 group";

            let badgeClass = 'badge-info';
            if (p.metadata.level === 'tease') badgeClass = 'badge-warning';
            if (p.metadata.level && p.metadata.level.includes('nsfw')) badgeClass = 'badge-error';

            const summary = p.korean_summary || "No Summary";

            card.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <span class="badge badge-sm ${badgeClass} bg-opacity-20 text-opacity-100 border-none uppercase text-[10px] font-bold tracking-wider">${p.metadata.level}</span>
                    <div class="flex items-center gap-1">
                        <button class="btn btn-circle btn-xs btn-ghost text-pink-400 hover:bg-pink-50 hover:text-pink-600" title="Generate Image" onclick="generateImage(this)">
                            üì∏
                        </button>
                        <button class="btn btn-circle btn-xs btn-ghost text-gray-400 hover:bg-pink-50 hover:text-pink-500" onclick="copyText(this, \`${p.positive.replace(/'/g, "\\'")}\`)">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                        </button>
                    </div>
                </div>
                <p class="prompt-text text-xs text-gray-600 font-mono leading-relaxed select-all h-20 overflow-y-auto custom-scrollbar" data-seed="${p.metadata.seed || ''}">${p.positive}</p>
                
                <div class="mt-3 pt-2 border-t border-dashed border-gray-200">
                    <p class="text-sm font-bold text-gray-700">üá∞üá∑ ${summary}</p>
                </div>
            `;

            if (insertAtTop) {
                container.insertBefore(card, container.firstChild);
            } else {
                container.appendChild(card);
            }
        }

        async function generatePrompt() {
            const btn = document.querySelector('.btn-primary');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="loading loading-spinner text-white"></span>';
            btn.disabled = true;

            const levelIdx = document.getElementById('level-slider').value;
            const category = document.getElementById('category-select').value;
            const count = document.getElementById('count-val').value;

            // Payload
            let payload = {
                mode: 'auto',
                character_id: selectedChar,
                level: LEVELS[levelIdx],
                category: category,
                count: parseInt(count)
            };

            // If in Builder Mode (or just check if values exist)
            // Even in Auto mode, if we wanted to support mix-and-match, we could.
            // But let's respect the user intent: if Builder Tab is active, read values.
            // Actually, for simplicity, let's always read them. If they are empty (value=""), backend ignores them.
            // Wait, if I am in Auto mode, I want 'random' logic from backend. 
            // In Builder mode, 'random' option has value="". So backend behavior is consistent.

            // However, the dropdowns are only visible in Builder mode.
            // If I am in Auto mode, the user expects 'random'. 
            // If I switch to Builder and select 'Hair A', then switch back to Auto, should 'Hair A' persist?
            // Probably not. The slider suggests a "preset". 
            // Let's stick to: If Builder Mode is active, pass the values. If Auto, pass nothing (or reset).

            // MERGED LOGIC: Always send all builder inputs.
            // Backend treats empty strings as 'random'.

            payload.mode = 'builder'; // Forcing builder mode logic effectively
            payload.hair = document.getElementById('b-hair').value;
            payload.top = document.getElementById('build-top').value;
            payload.bottom = document.getElementById('build-bottom').value;
            payload.outer = document.getElementById('build-outer').value;
            payload.male_character = document.getElementById('duo-male') ? document.getElementById('duo-male').value : null;
            payload.duo_position = document.getElementById('duo-position') ? document.getElementById('duo-position').value : null;
            payload.public_location = document.getElementById('public-loc') ? document.getElementById('public-loc').value : null;

            // AI Director
            payload.camera_angle = document.getElementById('dir-angle') ? document.getElementById('dir-angle').value : null;
            payload.camera_lens = document.getElementById('dir-lens') ? document.getElementById('dir-lens').value : null;
            payload.pose = document.getElementById('b-pose').value;
            payload.location = document.getElementById('b-location').value;

            try {
                const response = await fetch('/api/generate-prompt', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (data.success) {
                    const ph = document.getElementById('placeholder');
                    if (ph) ph.style.display = 'none';
                    const container = document.getElementById('results-container');

                    // Load current history once
                    let history = JSON.parse(localStorage.getItem('promptHistory') || '[]');

                    // Add all new prompts to top (reversed so first generated is at top, or just insert)
                    // data.prompts is array of new prompts.
                    // If we want newest first, we reverse inputs or unshift in reverse order?
                    // Actually, unshift adds to front. If we have [A, B] and unshift A then B, result is [B, A].
                    // Let's assume data.prompts is [P1, P2]. We want [P1, P2, Old...].
                    // So we should put them in front.

                    data.prompts.reverse().forEach(p => history.unshift(p));

                    // Limit
                    if (history.length > 50) history = history.slice(0, 50);
                    localStorage.setItem('promptHistory', JSON.stringify(history));

                    // Render Page
                    // We need to update the global 'cachedHistory' used by pagination too?
                    // saveHistory() does 'cachedHistory = ...'.
                    // Let's just update globals manually or call a function that reloads.
                    // loadHistory() does this.

                    loadHistory();

                    // Manually hide placeholder if loadHistory didn't do it (it does if >0)
                } else {
                    alert('Error: ' + data.error);
                }

            } catch (e) {
                alert('Network Error: ' + e);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function copyText(btn, text) {
            navigator.clipboard.writeText(text);
            const originalIcon = btn.innerHTML;
            btn.innerHTML = '‚úì';
            btn.classList.add('text-green-500', 'font-bold');
            setTimeout(() => {
                btn.innerHTML = originalIcon;
                btn.classList.remove('text-green-500', 'font-bold');
            }, 1500);
        }

        // === Image Gen & Gallery Logic ===

        function switchRightTab(tabName, tabElement) {
            // Remove active style from siblings
            const container = tabElement.parentElement;
            container.querySelectorAll('.btn').forEach(b => {
                b.classList.remove('bg-white', 'shadow-sm', 'text-pink-500');
                b.classList.add('text-gray-400');
            });

            // Add active style to current
            tabElement.classList.remove('text-gray-400');
            tabElement.classList.add('bg-white', 'shadow-sm', 'text-pink-500');

            if (tabName === 'results') {
                document.getElementById('tab-results').classList.remove('hidden');
                document.getElementById('tab-gallery').classList.add('hidden');
            } else {
                document.getElementById('tab-results').classList.add('hidden');
                document.getElementById('tab-gallery').classList.remove('hidden');
                loadGallery();
            }
        }

        async function generateImage(btn) {
            // Find parent card to locate prompt text
            const cardBody = btn.closest('.card-body');
            const promptEl = cardBody.querySelector('.prompt-text');
            const prompt = promptEl.innerText;
            const seed = promptEl.getAttribute('data-seed') || null;

            if (!prompt) return alert("Error: No prompt found");

            // UI Feedback
            const originalIcon = btn.innerHTML;
            btn.innerHTML = '<span class="loading loading-spinner loading-xs"></span>';
            btn.disabled = true;

            try {
                const response = await fetch('/api/generate-image', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: prompt, seed: seed ? parseInt(seed) : null })
                });
                const data = await response.json();

                if (data.success) {
                    alert("Image Check: " + data.local_path);
                } else {
                    alert('Gen Failed: ' + data.error);
                }
            } catch (e) {
                alert('Error: ' + e);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function loadGallery() {
            const container = document.getElementById('gallery-container');
            try {
                const res = await fetch('/api/gallery');
                const data = await res.json();

                if (data.success) {
                    container.innerHTML = ''; // Clear existing content
                    GALLERY_IMAGES = data.images; // Store for lightbox

                    if (GALLERY_IMAGES.length === 0) {
                        container.innerHTML = '<div class="col-span-full text-center py-10 text-gray-400">No images yet...</div>';
                        return;
                    }

                    container.innerHTML = data.images.map((img, index) => `
                            <div class="gallery-item group" onclick="openLightbox(${index})">
                                <img src="${img.url}" loading="lazy" />
                                <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                                    <span class="text-white font-bold text-xs">View</span>
                                </div>
                            </div>
                        `).join('');
                }
            } catch (e) {
                container.innerHTML = '<div class="text-red-500">Failed to load gallery</div>';
            }
        }

        function openLightbox(index) {
            currentGalleryIndex = index;
            updateLightboxUI();
            document.getElementById('lightbox_modal').showModal();
        }

        function navGallery(delta) {
            currentGalleryIndex += delta;
            // Wraparound
            if (currentGalleryIndex < 0) currentGalleryIndex = GALLERY_IMAGES.length - 1;
            if (currentGalleryIndex >= GALLERY_IMAGES.length) currentGalleryIndex = 0;
            updateLightboxUI();
        }

        function updateLightboxUI() {
            if (GALLERY_IMAGES.length === 0) return;
            const img = GALLERY_IMAGES[currentGalleryIndex];
            const display = document.getElementById('lightbox-img');
            const counter = document.getElementById('lightbox-counter');

            display.src = img.url;
            counter.innerText = `${currentGalleryIndex + 1} / ${GALLERY_IMAGES.length} ‚Ä¢ ${img.filename}`;
        }

        // Initialize Lang
        updateLangUI();
    </script>
</body>

</html>